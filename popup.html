<style>
body {
    min-width: 457px;
    overflow-x: hidden;
    font-family: Verdana, Arial, Times New Roman, Helvetica;
}

h1 {
    font-size: 0.95em;
}

fieldset {
    border: 1px solid #091A6C;
    margin-top: 10px;
}

fieldset legend {
    border: 1px solid #091A6C;
    background-color: #B2BAD9;
    padding: 1px 12px;
    width: 200px;
}

.field label {
    width: 200px;
    float: left;
}
</style>

<script type="text/javascript" src="jquery-1.3.2.js"> </script>
<script type="text/javascript" src="jquery.xml2json.js"> </script>
<script type="text/javascript" src="sha1.js"> </script>
<script>
var savedFields = ['serverDomain', 'contextPath', 'securitySalt'];

if (console == undefined) {
    var console = new Object();
    console.debug = function(msg) {};
}
// html elements used in script:
var form = null;
var callFields = null;
var callSelector = null
var messageElem = null

// transient values:
var fieldSetAlreadyFocused = false;
var callParams = new Array();

function clearCallConfigFields() {
    callParams = new Array();
    clearElemChildren(callFields);
}
function clearElemChildren(elem) {
    if (elem.hasChildNodes()) {
        while (elem.childNodes.length >= 1) {
            elem.removeChild(elem.firstChild);
        }
    }
}

function addCallConfigField(fldName, fldDesc, defVal) {
    var div = document.createElement('div');
    var label = document.createElement('label');
    var input = document.createElement('input');
    div.className = 'field';
    label.htmlFor = fldName;
    label.appendChild(document.createTextNode(fldDesc));
    input.type = 'text';
    input.name = fldName;
    input.value = defVal;
    div.appendChild(label);
    div.appendChild(input);
    callParams.push(fldName);
    callFields.appendChild(div);
    if (fieldSetAlreadyFocused == false) {
        setTimeout(function() {
            input.focus();
        }, 100);
        fieldSetAlreadyFocused = true;
    }
}

function isValidCallSelected(selector) {
    return selector.value != '__NOCALL__';
}
function callChanged(selector) {
    if (!isValidCallSelected(selector)) {
        return false;
    }
    console.debug('new call selected: ' + selector.value);
    clearCallConfigFields();
    switch(selector.value) {
        case 'isMeetingRunning':
            addCallConfigField('meetingID', 'Meeting ID:', 'test123');
            addCallConfigField('meetingToken', 'Meeting Token:', '');
            break;
        default:
            clearCallConfigFields();
            showMessage('No configurable fields for this call [' + selector.value + ']');
            callSelector.focus();
            break;
    }

}

function saveValues() {
    console.debug('saveValues');
    for(var i = 0; i < savedFields.length; i++) {  
        console.debug('save field: ' + savedFields[i]);
        var elem = eval('form.' + savedFields[i]);
        console.debug('value: ' + elem.value);
        localStorage[savedFields[i]] = elem.value;
    }
}

function loadValues() {
    console.debug('loadValues');
    for(var i = 0; i < savedFields.length; i++) {  
        console.debug('load field: ' + savedFields[i]);
        var elem = eval('form.' + savedFields[i]);
        console.debug('value: ' + elem.value);
        var loaded = localStorage[savedFields[i]];
        if (loaded != undefined) {
            elem.value = loaded;
        }
    }
}

function configurePage() {
    form = document.getElementById('mainForm');
    callFields = document.getElementById('perCallFields');
    callSelector = document.getElementById('callSelector');
    messageElem = document.getElementById('message');
    loadValues();
    callSelector.focus();
}

function showMessage(msg, xml) {
    clearElemChildren(messageElem);
    messageElem.appendChild(document.createTextNode(msg));
    if (xml != undefined && xml != null) {
        var pre = document.createElement('pre');
        pre.innerHTML = xml.replace(/></g,">\n<").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        messageElem.appendChild(pre);
    }
}

function encodeQueryParams(params) {
    var ret = [];
    for (var d in params) {
        ret.push(encodeURIComponent(d) + "=" + encodeURIComponent(params[d]));
    }
    return ret.join("&");
}

function makeAPICall() {
    saveValues();
    showMessage('Making API call...');
    /*
    Example URLs (these don't have checksums):
    http://devbuild.bigbluebutton.org/bigbluebutton/api/create?meetingID=123456&name=Test&attendeePW=abc&moderatorPW=qwe
    http://devbuild.bigbluebutton.org/bigbluebutton/api/join?meetingID=123456&fullName=JT+Moderator&password=qwe
    http://devbuild.bigbluebutton.org/bigbluebutton/api/join?meetingID=123456&fullName=JT+Attendee&password=abc
    http://devbuild.bigbluebutton.org/bigbluebutton/api/isMeetingRunning?meetingID=123456
    http://devbuild.bigbluebutton.org/bigbluebutton/api/getMeetingInfo?meetingID=123456
    */
    var domain = form.serverDomain.value;
    var salt = form.securitySalt.value;
    var context = form.contextPath.value;
    if (context.substr(context.length - 1) != '/') {
        context = context + '/';
    }
    var callName = form.callSelector.value;

    var params = new Array();
    for (var i = 0; i < callParams.length; i++) {
        var elem = eval('form.' + callParams[i]);
        params[callParams[i]] = elem.value;
    }

    if (containsValue(params['meetingID'])) {
        params = removeKey(params, 'meetingToken');
    } else {
        params = removeKey(params, 'meetingID');
    }

    if (containsValue(salt)) {
        params['checksum'] = createChecksum(salt, encodeQueryParams(params));
    }

    var url = "http://" + domain + context + callName + "?" + encodeQueryParams(params);
    console.debug('Call URL: ' + url);

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        apiCallReadyStateChange(xhr);
    };
    xhr.open("GET", url, true);
    xhr.send(null);

    return false;
}

function createChecksum(salt, queryString) {
    return hex_sha1(queryString + salt);
}

function containsValue(val) {
    return val != null && val != '';
}

function removeKey(arr, key) {
    var tmpArray = new Array();
    for(var i in arr) {
        if(i != key) { tmpArray[i] = arr[i]; }
    }
    return tmpArray;
}

function apiCallReadyStateChange(xhr) {
    if (xhr.readyState == 4) {
        if (xhr.status == 200 || xhr.status == 0) {
            console.debug('success');
            console.debug("xhr.status: " + xhr.status + ' [' + xhr.statusText + ']');
            console.debug("Response Text:\n" + xhr.responseText);
        } else {
            alert('There was a problem calling the API: ' + xhr.status + ' [' + xhr.statusText + ']');
            return;
        }

        var response = xhr.responseText;
        if (response == undefined || response == null) {
	        alert('error - response is undefined');
	        return;
        }

        showMessage('Response XML:', response);
        var resp = $.xml2json(response);
        var status = resp.returncode;
        var msg = resp.message;

        if('SUCCESS' == status) {
        } else{ 
	        alert('error in json response: ' + msg);
        }
    }
}
</script>

<body onload="configurePage();">
<div>
    <h1>Test a BigBlueButton API Call</h1>
    <p id="message"></p>
    <form id="mainForm" action="#" method="post" onsubmit="return makeAPICall();">
        <div class="field">
            <label for="callSelector">API Call:</label>
            <select id="callSelector" name="callSelector" onchange="callChanged(this)">
                <option value="__NOCALL__">-- Choose One --</option>
                <option value="isMeetingRunning">isMeetingRunning</option>
                <option value="getMeetingInfo">getMeetingInfo</option>
                <option value="create">create</option>
                <option value="join">join</option>
            </select>
        </div>
        <fieldset id="configFields">
            <legend>Call Configuration</legend>
            <div id="perCallFields">
            </div>
        </fieldset>
        <fieldset id="serverFields">
            <legend>Server Configuration</legend>
            <div class="field">
                <label for="serverDomain">Server:</label>
                <input type="text" name="serverDomain" value="devbuild.bigbluebutton.org" />
            </div>
            <div class="field">
                <label for="contextPath">Context Path:</label>
                <input type="text" name="contextPath" value="/bigbluebutton/api" />
            </div>
            <div class="field">
                <label for="securitySalt">Security Salt:</label>
                <input type="text" name="securitySalt" value="e2680968548ccc9d80e4fbe99faa8cc1" />
            </div>
        </fieldset>
        <input type="submit" value="Make Call" />
    </form>
</div>
</body>
